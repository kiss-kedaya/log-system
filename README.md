# 日志系统

这是一个基于 Next.js 框架的日志系统，使用 Neon 数据库存储日志数据，并可部署在 Vercel 平台上。系统采用 RSA/AES 混合加密方案保证数据传输安全性，并通过密钥验证控制系统访问权限。

## 功能特点

- **系统安全**：
  - 密钥验证：通过RSA加密的密钥验证控制系统访问权限
  - JWT认证：使用JWT令牌管理用户会话
  - API授权：所有API请求必须携带有效的JWT令牌
  
- **日志管理**：
  - 查看日志：表格形式直观展示所有日志数据
  - 删除日志：支持单条日志删除和批量选择删除功能，带确认对话框
  
- **日志表格功能**：
  - 多列排序：支持按任意列升序/降序排序
  - 对象预览：鼠标悬停在[Object]字段时显示详细JSON内容
  - 数据展开：点击展开按钮查看完整日志内容
  - 批量操作：支持多选功能，可同时选择多条日志进行批量删除
  - 日志搜索：支持按关键词和日期范围筛选日志

- **混合加密方案**：
  - RSA/AES混合加密：结合两种算法的优势，确保安全高效的数据传输
  - 非对称加密：使用RSA算法安全传输临时AES密钥和验证密钥
  - 对称加密：使用AES-256-CBC加密实际数据内容
  - 公钥管理：客户端自动从服务器获取并本地存储RSA公钥
  
- **响应式UI**：
  - 适配移动设备和桌面设备
  - 深色模式支持

## 安全特性

- **访问控制系统**：
  - 系统密钥验证：所有访问需先通过密钥验证
  - JWT令牌授权：验证成功后生成带时效的JWT令牌
  - 自动重定向：未授权访问自动重定向到登录页
  - 全局中间件：统一拦截未授权请求
  
- **混合加密架构**：
  - 客户端生成随机AES密钥用于数据加密
  - RSA公钥加密AES密钥，确保密钥传输安全
  - RSA私钥保存在服务器端，不会暴露
  - 每次传输使用全新的随机AES密钥和IV

- **加密数据格式**：
  - 结构化二进制数据格式，包含版本号、密钥长度等元数据
  - 完整格式：协议版本(1字节) + 加密密钥长度(4字节) + RSA加密的AES密钥 + IV(16字节) + AES加密的数据

- **环境变量配置**：
  - 系统密钥和JWT密钥通过环境变量注入
  - 加密密钥和参数通过环境变量注入，支持不同环境使用不同配置
  - RSA密钥对自动生成和管理

- **随机IV生成**：每次加密自动生成随机初始化向量，提高安全性

## 系统架构

### 验证与数据流程

```
                 +-------------+
                 |             |
+-------------+  | 密钥验证     |  +-------------+                +-------------+
|             |  | (RSA加密)    |  |             |  解密并处理     |             |
| 客户端(浏览器) | -------------→| 服务器验证API  | -------------→|  JWT令牌签发  |
|             |                |             |                |             |
+-------------+                +-------------+                +-------------+
                                                                    |
                                                                    ↓
+-------------+                +-------------+                +-------------+
|             |  混合加密数据    |             |  验证令牌       |             |
| 客户端请求    | -------------→| API中间件    | -------------→|  API处理     |
|             |                |             |                |             |
+-------------+                +-------------+                +-------------+
       ↑                                                            |
       |                                                            |
       |              +-------------+                               |
       |              |             |                               |
       +--------------+ 加密响应数据  +-------------------------------+
                      |             |
                      +-------------+
```

### 认证流程

```
登录验证流程:
1. 用户输入系统密钥，使用RSA公钥加密密钥
2. 发送加密的密钥到验证API
3. 服务器使用RSA私钥解密并验证密钥是否正确
4. 验证成功后生成JWT令牌并返回
5. 客户端存储JWT令牌用于后续请求

API访问流程:
1. 客户端请求带上JWT令牌(Authorization头)
2. 中间件验证令牌有效性
3. 无效/过期令牌返回401错误
4. 有效令牌允许继续处理请求
```

### 前端组件结构

- **LogViewer**: 主要表格组件，负责展示、排序和管理日志
- **LogForm**: 表单组件，负责日志添加
- **加密模块**: 客户端加密/解密处理
  - clientHybridCrypto.ts: 混合加密实现
  - cryptoConfig.ts: 共享加密配置

### 后端组件

- **API路由**: 处理日志的增删查操作(/api/logs/route.ts)
- **加密模块**:
  - hybridCrypto.ts: 服务器端混合加密/解密实现
  - rsaUtils.ts: RSA密钥对管理
- **数据库连接**: Neon PostgreSQL数据库连接与查询(db.ts)

## 快速开始

### 前提条件

1. [Node.js](https://nodejs.org/) 18.0.0 或更高版本
2. [Neon](https://neon.tech/) 数据库账户

### 安装步骤

1. 克隆仓库

```bash
git clone <仓库地址>
cd log-system
```

2. 安装依赖

```bash
npm install
```

3. 创建 `.env.local` 文件并配置环境变量

```
DATABASE_URL="postgresql://user:password@endpoint.neon.tech/dbname?sslmode=require"
# 用于服务器响应加密的密钥
SERVER_AES_KEY="你的服务器AES加密密钥"
```

获取 Neon 数据库连接字符串的步骤:

- 注册/登录 [Neon](https://neon.tech/)
- 创建一个新项目
- 在项目的"Connection Details"部分获取连接字符串
- 将连接字符串复制到 `.env.local` 文件中

4. 运行开发服务器

```bash
npm run dev
```

访问 <http://localhost:3000> 查看应用

### 生产部署

项目可以轻松部署到 Vercel 平台：

1. 在 [Vercel](https://vercel.com) 创建账户
2. 导入你的 GitHub 仓库
3. 在环境变量中添加 `DATABASE_URL` 和 `SERVER_AES_KEY`
4. 部署应用

## API 使用说明

由于系统使用混合加密，API不再直接接受明文JSON。所有请求和响应均为加密的二进制数据。

### 密钥初始化

- 端点: `/api/initKeys`
- 方法: `GET`
- 响应: 包含RSA公钥的JSON数据

### 日志上传

- 端点: `/api/logs`
- 方法: `POST`
- 内容类型: `application/octet-stream`
- 请求体: 使用混合加密方案加密的二进制数据

### 获取日志

- 端点: `/api/logs`
- 方法: `GET`
- 响应: 加密的二进制数据(application/octet-stream)

### 删除日志

单条删除:

- 端点: `/api/logs?id={日志ID}`
- 方法: `DELETE`
- 响应: 加密的二进制数据(application/octet-stream)

批量删除:

- 端点: `/api/logs`
- 方法: `DELETE`
- 请求体: 包含要删除的日志ID数组的加密二进制数据
- 响应: 加密的二进制数据(application/octet-stream)

## 技术栈

- [Next.js](https://nextjs.org/) - React 框架
- [Neon](https://neon.tech/) - 无服务器 PostgreSQL 数据库
- [Tailwind CSS](https://tailwindcss.com/) - 样式框架
- [TypeScript](https://www.typescriptlang.org/) - 类型检查
- [CryptoJS](https://github.com/brix/crypto-js) - 客户端加密库
- [Node Crypto](https://nodejs.org/api/crypto.html) - 服务器端加密
- [JWT](https://jwt.io/) - JSON Web Token认证
- [Next.js Middleware](https://nextjs.org/docs/app/building-your-application/routing/middleware) - API中间件认证

## 开发历程

本项目经历了多个版本迭代，每次迭代都增强了功能和安全性：

### 1. 基础版本

- 实现了日志表格展示的基本功能
- 使用明文JSON传输数据
- 添加了简单的日志提交表单

### 2. 增强表格功能

- 添加了按列排序功能，支持升序/降序
- 实现了鼠标悬停在[Object]字段时显示对象详情的功能
- 添加了日志展开/折叠功能，方便查看完整日志内容

### 3. 添加日志删除功能

- 实现了单条日志删除功能
- 添加了删除确认对话框，防止误操作
- 优化了成功/错误提示信息展示

### 4. 安全性增强 - API端加密

- 添加了AES加密保护API传输的数据
- 实现了服务器端加密/解密功能
- 支持不同密钥长度（128/192/256位）自动选择加密算法

### 5. 客户端加密改进

- 将加密过程从服务器端移至客户端，实现端到端加密
- 支持从环境变量设置IV向量，增强安全性
- 优化了错误处理和加密参数配置

### 6. 二进制传输优化

- 使用二进制字节集(ArrayBuffer)替代Base64传输加密数据
- 优化了前后端数据交换格式，提高性能
- 完善了相关错误处理和类型安全

### 7. 混合加密系统升级

- 实现了RSA/AES混合加密方案，解决密钥管理难题
- 添加了RSA密钥对自动生成和管理功能
- 优化了加密数据格式，增加协议版本支持
- 完善了加密参数配置和兼容性处理

### 8. 批量操作功能

- 添加了多选功能，支持批量选择日志
- 实现了批量删除功能，提高操作效率
- 增强了UI交互和用户体验

### 9. 搜索与过滤功能

- 添加了关键词搜索功能，支持在所有日志内容中搜索
- 实现了日期范围筛选，可精确查找特定时间段的日志
- 优化了UI布局和用户交互体验

### 10. 访问控制与认证系统

- 添加了基于RSA加密的系统密钥验证
- 实现了JWT令牌身份验证和会话管理
- 添加了统一的API认证中间件拦截未授权请求
- 实现了客户端API请求统一携带认证令牌
- 增加了登出功能和令牌自动过期处理

## 许可证

[MIT](LICENSE)

## 故障排除

### 常见问题

1. **加密错误**
   - 问题: "解密数据失败"或"加密数据失败"错误
   - 解决方案: 检查加密系统初始化是否成功，刷新页面重新获取RSA公钥

2. **RSA解密错误**
   - 问题: "RSA解密失败"或"RSA私钥操作失败"
   - 解决方案: 确认RSA密钥对已正确生成，可能需要重新生成或检查密钥目录权限

3. **数据展示为空白**
   - 问题: 提交日志成功但表格不显示数据
   - 解决方案: 检查浏览器控制台是否有解密错误，可能需要清除本地存储并重新初始化

### 调试技巧

- 开启浏览器开发者工具查看网络请求和响应
- 检查服务器日志中的加密/解密相关的调试信息
- 使用测试端点验证加密系统的各部分是否正常工作
