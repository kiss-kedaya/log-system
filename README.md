# 日志系统

这是一个基于 Next.js 框架的日志系统，使用 Neon 数据库存储日志数据，并可部署在 Vercel 平台上。系统采用端到端加密方案保证数据传输安全性。

## 功能特点

- **日志管理**：
  - 添加日志：通过前端界面或API上传JSON格式的日志数据
  - 查看日志：表格形式直观展示所有日志数据
  - 删除日志：支持单条日志删除，带确认对话框
  
- **日志表格功能**：
  - 多列排序：支持按任意列升序/降序排序
  - 对象预览：鼠标悬停在[Object]字段时显示详细JSON内容
  - 数据展开：点击展开按钮查看完整日志内容
  
- **端到端加密**：
  - 客户端加密：浏览器内直接加密数据后传输
  - 二进制传输：使用ArrayBuffer/Blob传输加密数据，高效安全
  - AES-CBC加密：支持128/192/256位密钥自动选择
  
- **响应式UI**：
  - 适配移动设备和桌面设备
  - 深色模式支持

## 安全特性

- **端到端加密**：所有日志数据在客户端加密后传输，保护敏感信息
- **二进制数据传输**：使用ArrayBuffer替代Base64传输加密数据，提高效率
- **环境变量配置**：加密密钥通过环境变量注入，支持不同环境使用不同密钥
- **随机IV生成**：每次加密自动生成随机初始化向量，提高安全性

## 系统架构

### 数据流程

```
+-------------+                +-------------+                +-------------+
|             |  加密二进制数据  |             |  解密并处理     |             |
| 客户端(浏览器) | -------------→| 服务器API端点 | -------------→|  数据库存储   |
|             |                |             |                |             |
+-------------+                +-------------+                +-------------+
       ↑                                                            |
       |                                                            |
       |              +-------------+                               |
       |              |             |                               |
       +--------------+ 加密响应数据  +-------------------------------+
                      |             |
                      +-------------+
```

### 前端组件结构

- **LogViewer**: 主要表格组件，负责展示、排序和管理日志
- **LogForm**: 表单组件，负责日志添加
- **加密模块**: 客户端加密/解密处理(clientCrypto.ts)

### 后端组件

- **API路由**: 处理日志的增删查操作(/api/logs/route.ts)
- **加密模块**: 服务器端加密/解密模块(crypto.ts)
- **数据库连接**: Neon PostgreSQL数据库连接与查询(db.ts)

## 快速开始

### 前提条件

1. [Node.js](https://nodejs.org/) 18.0.0 或更高版本
2. [Neon](https://neon.tech/) 数据库账户

### 安装步骤

1. 克隆仓库

```bash
git clone <仓库地址>
cd log-system
```

2. 安装依赖

```bash
npm install
```

3. 创建 `.env.local` 文件并配置环境变量

```
DATABASE_URL="postgresql://user:password@endpoint.neon.tech/dbname?sslmode=require"
NEXT_PUBLIC_AES_KEY="你的AES加密密钥" # 用于浏览器端加密
```

获取 Neon 数据库连接字符串的步骤:
- 注册/登录 [Neon](https://neon.tech/)
- 创建一个新项目
- 在项目的"Connection Details"部分获取连接字符串
- 将连接字符串复制到 `.env.local` 文件中

4. 运行开发服务器

```bash
npm run dev
```

访问 http://localhost:3000 查看应用

### 生产部署

项目可以轻松部署到 Vercel 平台：

1. 在 [Vercel](https://vercel.com) 创建账户
2. 导入你的 GitHub 仓库
3. 在环境变量中添加 `DATABASE_URL` 和 `NEXT_PUBLIC_AES_KEY`
4. 部署应用

## API 使用说明

由于系统使用端到端加密，API不再直接接受明文JSON。所有请求和响应均为加密的二进制数据。

### 日志上传

- 端点: `/api/logs`
- 方法: `POST`
- 内容类型: `application/octet-stream`
- 请求体: 使用AES-CBC加密的二进制数据

### 获取日志

- 端点: `/api/logs`
- 方法: `GET`
- 响应: 加密的二进制数据(application/octet-stream)

### 删除日志

- 端点: `/api/logs?id={日志ID}`
- 方法: `DELETE`
- 响应: 加密的二进制数据(application/octet-stream)

## 技术栈

- [Next.js](https://nextjs.org/) - React 框架
- [Neon](https://neon.tech/) - 无服务器 PostgreSQL 数据库
- [Tailwind CSS](https://tailwindcss.com/) - 样式框架
- [TypeScript](https://www.typescriptlang.org/) - 类型检查
- [CryptoJS](https://github.com/brix/crypto-js) - 客户端加密库
- [Node Crypto](https://nodejs.org/api/crypto.html) - 服务器端加密

## 开发历程

本项目经历了多个版本迭代，每次迭代都增强了功能和安全性：

### 1. 基础版本
- 实现了日志表格展示的基本功能
- 使用明文JSON传输数据
- 添加了简单的日志提交表单

### 2. 增强表格功能
- 添加了按列排序功能，支持升序/降序
- 实现了鼠标悬停在[Object]字段时显示对象详情的功能
- 添加了日志展开/折叠功能，方便查看完整日志内容

### 3. 添加日志删除功能
- 实现了单条日志删除功能
- 添加了删除确认对话框，防止误操作
- 优化了成功/错误提示信息展示

### 4. 安全性增强 - API端加密
- 添加了AES加密保护API传输的数据
- 实现了服务器端加密/解密功能
- 支持不同密钥长度（128/192/256位）自动选择加密算法

### 5. 客户端加密改进
- 将加密过程从服务器端移至客户端，实现端到端加密
- 支持从环境变量设置IV向量，增强安全性
- 优化了错误处理和加密参数配置

### 6. 二进制传输优化
- 使用二进制字节集(ArrayBuffer)替代Base64传输加密数据
- 优化了前后端数据交换格式，提高性能
- 完善了相关错误处理和类型安全

## 许可证

[MIT](LICENSE)

## 故障排除

### 常见问题

1. **加密错误**
   - 问题: "解密数据失败"或"加密数据失败"错误
   - 解决方案: 确认环境变量`NEXT_PUBLIC_AES_KEY`已正确设置，并且前后端使用相同密钥

2. **数据展示为空白**
   - 问题: 提交日志成功但表格不显示数据
   - 解决方案: 检查浏览器控制台是否有解密错误，确认客户端和服务器的加密密钥一致

3. **二进制数据显示错误**
   - 问题: 接收到的数据显示为乱码或格式错误
   - 解决方案: 确保使用`arrayBuffer()`而非`text()`方法获取响应数据

### 调试技巧

- 开启浏览器开发者工具查看网络请求和响应
- 检查服务器日志中的错误信息
- 临时添加`console.log`查看加密/解密过程中的数据格式
